From da50b02570428882e056c32061621dc175bba3ba Mon Sep 17 00:00:00 2001
From: Darren Oh <9472-darrenoh@users.noreply.drupalcode.org>
Date: Sat, 28 Dec 2024 20:10:12 -0500
Subject: [PATCH] Issue #3496399: Add ability to skip previously applied
 recipes

---
 .../drupal_cms_installer/drupal_cms_installer.profile     | 8 +++++++-
 .../drupal_cms_installer/src/Form/RecipesForm.php         | 6 ++++++
 2 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/project_template/web/profiles/drupal_cms_installer/drupal_cms_installer.profile b/project_template/web/profiles/drupal_cms_installer/drupal_cms_installer.profile
index 2efa9e6c..dea4eb7d 100644
--- a/project_template/web/profiles/drupal_cms_installer/drupal_cms_installer.profile
+++ b/project_template/web/profiles/drupal_cms_installer/drupal_cms_installer.profile
@@ -235,6 +235,12 @@ function _drupal_cms_installer_password_value(&$element, $input, FormStateInterf
  *   The batch job definition.
  */
 function drupal_cms_installer_apply_recipes(array &$install_state): array {
+  // Skip previously applied recipes.
+  $applied_recipes = array_map('basename', \Drupal::state()->get('project_browser.applied_recipes', []));
+  $recipes = array_diff($install_state['parameters']['recipes'], $applied_recipes);
+  if (empty($recipes)) {
+    return [];
+  }
   $batch = install_profile_modules($install_state);
   $batch['title'] = t('Setting up your site');
 
@@ -243,7 +249,7 @@ function drupal_cms_installer_apply_recipes(array &$install_state): array {
 
   $recipe_operations = [];
 
-  foreach ($install_state['parameters']['recipes'] as $recipe) {
+  foreach ($recipes as $recipe) {
     $recipe = RecipeLoader::load(
       $cookbook_path . '/' . $recipe,
       // Only save a cached copy of the recipe if this environment variable is
diff --git a/project_template/web/profiles/drupal_cms_installer/src/Form/RecipesForm.php b/project_template/web/profiles/drupal_cms_installer/src/Form/RecipesForm.php
index 5bf6e271..4266623a 100644
--- a/project_template/web/profiles/drupal_cms_installer/src/Form/RecipesForm.php
+++ b/project_template/web/profiles/drupal_cms_installer/src/Form/RecipesForm.php
@@ -49,6 +49,7 @@ final class RecipesForm extends InstallerFormBase {
     $composer = json_decode($composer, TRUE, flags: JSON_THROW_ON_ERROR);
     $optional_recipes = array_keys($composer['suggest'] ?? []);
 
+    $applied_recipes = array_map('basename', \Drupal::state()->get('project_browser.applied_recipes', []));
     foreach ($optional_recipes as $name) {
       $recipe = $cookbook_path . '/' . basename($name) . '/recipe.yml';
       if (file_exists($recipe)) {
@@ -56,6 +57,11 @@ final class RecipesForm extends InstallerFormBase {
         $recipe = Yaml::decode($recipe);
         $key = basename($name);
         $form['add_ons']['#options'][$key] = $recipe['name'];
+        // Previously applied recipes are selected and cannot be deselected.
+        if (in_array($key, $applied_recipes)) {
+          $form['add_ons']['#default_value'][] = $key;
+          $form['add_ons'][$key]['#disabled'] = TRUE;
+        }
       }
     }
 
-- 
GitLab

